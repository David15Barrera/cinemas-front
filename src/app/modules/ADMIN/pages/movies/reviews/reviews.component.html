<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.2/dist/full.css" rel="stylesheet" type="text/css" />

<div class="p-4 sm:p-8 max-w-7xl mx-auto font-sans">
  <h1 class="text-4xl font-extrabold mb-8 text-base-content text-center border-b-2 pb-2">
    Opiniones de la Película
  </h1>

  @if (loading) {
    <div class="flex justify-center py-10">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
  }

  @if (!loading && reviews.length > 0) {
    <div class="flex flex-col sm:flex-row items-center justify-between mb-8 p-4 bg-base-200 rounded-lg shadow-inner border border-base-300">
      
      <div class="text-lg font-semibold text-base-content mb-4 sm:mb-0">
        {{ reviews.length }} opinión{{ reviews.length !== 1 ? 'es' : '' }} publicadas
      </div>

      <div class="flex items-center gap-3">
        <label class="flex items-center gap-2 text-base-content font-medium">
          <span class="text-sm">Filtrar por calificación:</span>
          <select
            class="select select-bordered select-sm focus:select-primary"
            [(ngModel)]="selectedRating"
            (change)="filterByRating()"
          >
            <option [ngValue]="null">Todas ({{ reviews.length }})</option>
            @for (r of [5,4,3,2,1]; track r) {
              <option [ngValue]="r">
                {{ r }} estrellas
              </option>
            }
          </select>
        </label>
      </div>
    </div>
  }

  @if (!loading && reviews.length === 0) {
    <div class="text-center text-base-content opacity-70 text-lg py-10">
      <div class="flex flex-col items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 opacity-30 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <p class="font-semibold text-xl text-base-content">Aún no hay opiniones</p>
          <p class="text-sm">Sé el primero en dejar un comentario para esta película.</p>
      </div>
    </div>   
  } @else if (!loading && filteredReviews.length === 0 && selectedRating !== null) {
    <div class="text-center text-base-content opacity-70 text-lg py-10">
      <div class="flex flex-col items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 opacity-30 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          <p class="font-semibold text-xl text-base-content">Sin resultados para {{ selectedRating }} estrellas</p>
          <p class="text-sm">Intente filtrar por "Todas" o una calificación diferente.</p>
      </div>
    </div>
  }

  @if (!loading && filteredReviews.length > 0) {
    <div class="space-y-6">
      @for (review of filteredReviews; track review.id) {
        <div
          class="card bg-base-100 shadow-lg border border-base-300 hover:shadow-xl hover:border-primary transition-all duration-300"
        >
          <div class="card-body p-6">
            <div class="flex gap-4">
              <div class="flex-shrink-0">
                <div class="avatar placeholder">
                  <div class="bg-primary text-primary-content w-12 h-12 rounded-full flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                  </div>
                </div>
              </div>
              
              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h3 class="font-semibold text-lg">{{ review.userName }}</h3>
                    <p class="text-xs opacity-60 flex items-center gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                      {{ review.createdAt | date : 'dd/MM/yyyy HH:mm' }}
                    </p>
                  </div>

                  <div class="flex items-center gap-2">
                    <div class="flex gap-0.5">
                      @for (star of [1,2,3,4,5]; track star) {
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          class="w-5 h-5"
                          [ngClass]="{
                            'text-warning fill-warning': star <= review.rating,
                            'text-base-300': star > review.rating
                          }"
                          viewBox="0 0 20 20"
                          fill="currentColor"
                        >
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.357 4.174a1 1 0 00.95.69h4.389c.969 0 1.371 1.24.588 1.81l-3.558 2.583a1 1 0 00-.364 1.118l1.357 4.174c.3.921-.755 1.688-1.538 1.118l-3.558-2.583a1 1 0 00-1.176 0l-3.558 2.583c-.783.57-1.838-.197-1.538-1.118l1.357-4.174a1 1 0 00-.364-1.118L2.063 9.601c-.783-.57-.38-1.81.588-1.81h4.389a1 1 0 00.95-.69l1.357-4.174z"/>
                        </svg>
                      }
                    </div>
                    <span class="font-bold text-lg">{{ review.rating }}.0</span>
                  </div>
                </div>

                <h4 class="font-semibold text-base mb-2 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7.9 20A14.9 14.9 0 0 0 12 21c4.5 0 8.5-1.5 11-4V5a2 2 0 0 0-2-2H3a2 2 0 0 0-2 2v12c0 1 1 2 2 2h3.9"/></svg>
                  {{ review.title || 'Sin título' }}
                </h4>

                <p class="text-sm opacity-80 mb-3">
                  {{ review.comment }}
                </p>

                <div
                  class="flex items-center justify-between pt-2 border-t border-base-200 mt-3"
                >
                  <div class="flex items-center gap-2 text-xs opacity-60">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></svg>
                    <span>ID: {{ review.id.substring(0, 8) }}...</span>
                  </div>

                  <button
                    class="btn btn-ghost btn-sm text-error gap-1 hover:bg-error/10 hover:text-error"
                    (click)="confirmDelete(review.id)"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                    Eliminar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

<dialog #deleteModal id="delete_review_modal" class="modal">
  <div class="modal-box">
    <h3 class="font-bold text-lg text-error flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
      Confirmar Eliminación
    </h3>
    <p class="py-4">¿Estás seguro de que deseas eliminar este comentario de forma permanente? Esta acción no se puede deshacer.</p>
    <div class="modal-action">
      <button type="button" class="btn btn-ghost" (click)="closeDeleteModal()">
        Cancelar
      </button>
      <button class="btn btn-error text-error-content" (click)="deleteReviewModal()">
        Eliminar
      </button>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button (click)="closeDeleteModal()">close</button>
  </form>
</dialog>