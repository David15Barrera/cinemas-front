<div class="container mx-auto p-6 space-y-6">
  <!-- Header -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
  >
    <div>
      <h2 class="text-3xl font-bold flex items-center gap-3">
        <i-lucide [img]="WalletIcon" class="w-8 h-8 text-primary"></i-lucide>
        Gestión Financiera
      </h2>
      <p class="text-sm opacity-70 mt-1">
        Administra tu cartera digital y transacciones
      </p>
    </div>
  </div>

  <!-- Estado de la cartera -->
  @if (!existWallet()) {
  <!-- No existe cartera -->
  <div
    class="card bg-gradient-to-br from-warning/20 to-warning/5 border-2 border-warning shadow-lg"
  >
    <div class="card-body">
      <div class="flex flex-col items-center justify-center py-8">
        <div class="bg-warning/20 p-6 rounded-full mb-4">
          <i-lucide
            [img]="AlertCircle"
            class="w-16 h-16 text-warning"
          ></i-lucide>
        </div>
        <h3 class="text-2xl font-bold mb-2">No tienes una cartera digital</h3>
        <p class="text-center opacity-70 mb-6 max-w-md">
          Para poder gestionar tus finanzas, pagos y recargas, necesitas crear
          una cartera digital.
        </p>
        <button class="btn btn-warning btn-lg gap-2" (click)="createWallet()">
          <i-lucide [img]="Plus" class="w-5 h-5"></i-lucide>
          Crear Cartera Digital
        </button>
      </div>
    </div>
  </div>
  } @else {
  <!-- Existe cartera -->

  <!-- Tarjeta de Balance -->
  <div
    class="card bg-gradient-to-br from-primary to-secondary text-primary-content shadow-xl"
  >
    <div class="card-body">
      <div
        class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4"
      >
        <div>
          <p class="text-sm opacity-80 mb-1">Balance Disponible</p>
          <h3 class="text-4xl font-bold flex items-center gap-2">
            <i-lucide [img]="DollarSign" class="w-8 h-8"></i-lucide>
            {{ wallet()!.balance | currency : "GTQ" : "symbol" : "1.2-2" }}
          </h3>
          <p class="text-xs opacity-70 mt-2">
            ID Cartera: {{ wallet()!.id.substring(0, 8) }}...
          </p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3">
          <button class="btn btn-success gap-2" (click)="openModalRecharge()">
            <i-lucide [img]="ArrowUpCircle" class="w-5 h-5"></i-lucide>
            Recargar Saldo
          </button>
          <button class="btn btn-error gap-2" (click)="openModalPayStay()">
            <i-lucide [img]="Home" class="w-5 h-5"></i-lucide>
            Pagar Estancia
          </button>
          <button class="btn btn-warning gap-2" (click)="openModalPayAdBlock()">
            <i-lucide [img]="Ban" class="w-5 h-5"></i-lucide>
            Bloquear Anuncios
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Información del Cine -->
  @if (cinema()) {
  <div class="alert alert-info shadow-md">
    <i-lucide [img]="Home" class="w-6 h-6"></i-lucide>
    <div class="flex-1">
      <h4 class="font-bold">{{ cinema()!.name }}</h4>
      <div class="text-xs opacity-80">
        Costo por día:
        <strong>{{
          cinema()!.dailyCost | currency : "GTQ" : "symbol" : "1.2-2"
        }}</strong>
      </div>
    </div>
  </div>
  }

  <!-- Estado del bloqueo de anuncios -->
  @if (hasActiveAdBlock() && activeAdBlock()) {
  <div class="alert alert-success shadow-md">
    <i-lucide [img]="CheckCircle" class="w-6 h-6"></i-lucide>
    <div class="flex-1">
      <h4 class="font-bold">Bloqueo de Anuncios Activo</h4>
      <div class="text-xs opacity-90">
        Vigente desde
        <strong>{{ activeAdBlock()!.startDate | date : "dd/MM/yyyy" }}</strong>
        hasta
        <strong>{{ activeAdBlock()!.endDate | date : "dd/MM/yyyy" }}</strong>
        •
        {{ activeAdBlock()!.durationDays }} día{{
          activeAdBlock()!.durationDays !== 1 ? "s" : ""
        }}
      </div>
    </div>
  </div>
  } @else {
  <div class="alert alert-warning shadow-md">
    <i-lucide [img]="AlertCircle" class="w-6 h-6"></i-lucide>
    <div class="flex-1">
      <h4 class="font-bold">Sin Bloqueo de Anuncios</h4>
      <div class="text-xs opacity-90">
        Actualmente se mostrarán anuncios en todas las páginas relacionadas con
        tu cine. Puedes bloquearlos realizando un pago.
      </div>
    </div>
  </div>
  }

  <!-- Estadísticas rápidas -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
    <div class="stats shadow border border-base-300">
      <div class="stat">
        <div class="stat-figure text-success">
          <i-lucide [img]="TrendingUp" class="w-8 h-8"></i-lucide>
        </div>
        <div class="stat-title">Total Transacciones</div>
        <div class="stat-value text-primary">{{ transactions().length }}</div>
      </div>
    </div>

    <div class="stats shadow border border-base-300">
      <div class="stat">
        <div class="stat-figure text-success">
          <i-lucide [img]="ArrowUpCircle" class="w-8 h-8"></i-lucide>
        </div>
        <div class="stat-title">Recargas</div>
        <div class="stat-value text-success">
          {{ getRechargesCount() }}
        </div>
      </div>
    </div>

    <div
      class="stats shadow border border-base-300 cursor-pointer hover:bg-base-200"
      (click)="openModalHistoryStay()"
    >
      <div class="stat">
        <div class="stat-figure text-error">
          <i-lucide [img]="Home" class="w-8 h-8"></i-lucide>
        </div>
        <div class="stat-title">Pagos Estancia</div>
        <div class="stat-value text-error">
          {{ getCinemaDebitsCount() }}
        </div>
        <div class="stat-desc text-xs flex items-center gap-1">
          <i-lucide [img]="Eye" class="w-3 h-3"></i-lucide>
          Ver historial
        </div>
      </div>
    </div>

    <div
      class="stats shadow border border-base-300 cursor-pointer hover:bg-base-200"
      (click)="openModalHistoryAdBlock()"
    >
      <div class="stat">
        <div class="stat-figure text-warning">
          <i-lucide [img]="Ban" class="w-8 h-8"></i-lucide>
        </div>
        <div class="stat-title">Bloqueos Anuncios</div>
        <div class="stat-value text-warning">
          {{ getAdBlocksCount() }}
        </div>
        <div class="stat-desc text-xs flex items-center gap-1">
          <i-lucide [img]="Eye" class="w-3 h-3"></i-lucide>
          Ver historial
        </div>
      </div>
    </div>

    <div class="stats shadow border border-base-300">
      <div class="stat">
        <div class="stat-figure text-info">
          <i-lucide [img]="ArrowDownCircle" class="w-8 h-8"></i-lucide>
        </div>
        <div class="stat-title">Otros Débitos</div>
        <div class="stat-value text-info">
          {{ getOtherDebitsCount() }}
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de transacciones -->
  <div class="card bg-base-100 shadow-md border border-base-300">
    <div class="card-body p-0">
      <div class="p-4 border-b border-base-300">
        <h3 class="text-xl font-bold flex items-center gap-2">
          <i-lucide [img]="Clock" class="w-6 h-6 text-primary"></i-lucide>
          Historial de Transacciones
        </h3>
      </div>

      <div class="overflow-x-auto">
        <table class="table table-zebra w-full">
          <thead class="bg-base-200">
            <tr>
              <th class="font-bold">Tipo</th>
              <th class="font-bold">Descripción</th>
              <th class="font-bold">Monto</th>
              <th class="font-bold">Fecha</th>
              <th class="font-bold">Estado</th>
            </tr>
          </thead>
          <tbody>
            @for (transaction of transactions(); track transaction.id) {
            <tr class="hover">
              <td>
                <div class="flex items-center gap-2">
                  <div
                    class="p-2 rounded-lg"
                    [ngClass]="{
                      'bg-success/10 text-success':
                        transaction.transactionType === 'recharge',
                      'bg-error/10 text-error': isDebit(
                        transaction.transactionType
                      )
                    }"
                  >
                    <i-lucide
                      [img]="getTransactionIcon(transaction.transactionType)"
                      class="w-5 h-5"
                    ></i-lucide>
                  </div>
                  <span class="font-medium">
                    {{ getTransactionTypeLabel(transaction.transactionType) }}
                  </span>
                </div>
              </td>
              <td>
                <div
                  class="max-w-md truncate"
                  [title]="transaction.description"
                >
                  {{ transaction.description }}
                </div>
              </td>
              <td>
                <span
                  class="font-bold"
                  [ngClass]="{
                    'text-success': transaction.transactionType === 'recharge',
                    'text-error': isDebit(transaction.transactionType)
                  }"
                >
                  {{ transaction.transactionType === "recharge" ? "+" : "-" }}
                  {{
                    transaction.amount | currency : "GTQ" : "symbol" : "1.2-2"
                  }}
                </span>
              </td>
              <td class="text-sm opacity-70">
                {{ transaction.transactionDate | date : "dd/MM/yyyy HH:mm" }}
              </td>
              <td>
                <span
                  class="badge badge-sm gap-1"
                  [ngClass]="{
                    'badge-success': transaction.transactionType === 'recharge',
                    'badge-error': isDebit(transaction.transactionType)
                  }"
                >
                  <i-lucide
                    [img]="
                      transaction.transactionType === 'recharge'
                        ? CheckCircle
                        : XCircle
                    "
                    class="w-3 h-3"
                  ></i-lucide>
                  {{
                    transaction.transactionType === "recharge"
                      ? "Ingreso"
                      : "Egreso"
                  }}
                </span>
              </td>
            </tr>
            } @empty {
            <tr>
              <td colspan="5" class="text-center py-12">
                <div class="flex flex-col items-center justify-center">
                  <div class="bg-base-200 p-6 rounded-full mb-4">
                    <i-lucide
                      [img]="Clock"
                      class="w-16 h-16 opacity-30"
                    ></i-lucide>
                  </div>
                  <h3 class="text-xl font-semibold mb-2">
                    No hay transacciones
                  </h3>
                  <p class="text-sm opacity-70">
                    Aún no se han realizado transacciones en esta cartera
                  </p>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Contador de transacciones -->
  @if (transactions().length > 0) {
  <div class="flex items-center justify-between">
    <div class="text-sm opacity-70">
      Mostrando
      <span class="font-semibold">{{ transactions().length }}</span>
      transacción{{ transactions().length !== 1 ? "es" : "" }}
    </div>
  </div>
  } }
</div>

<!-- Modal de Recarga -->
<dialog #modalRecharge id="modal-recharge" class="modal">
  <div class="modal-box">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-success/10 p-3 rounded-lg">
          <i-lucide
            [img]="ArrowUpCircle"
            class="w-6 h-6 text-success"
          ></i-lucide>
        </div>
        <div>
          <h3 class="text-xl font-bold">Recargar Saldo</h3>
          <p class="text-sm opacity-70">Agrega fondos a tu cartera digital</p>
        </div>
      </div>
      <button
        class="btn btn-ghost btn-sm btn-circle"
        (click)="closeModalRecharge()"
      >
        <i-lucide [img]="X" class="w-5 h-5"></i-lucide>
      </button>
    </div>

    <!-- Balance actual -->
    <div class="alert alert-info mb-4">
      <i-lucide [img]="WalletIcon" class="w-5 h-5"></i-lucide>
      <div>
        <p class="text-sm">Balance actual:</p>
        <p class="font-bold">
          {{ wallet()?.balance | currency : "GTQ" : "symbol" : "1.2-2" }}
        </p>
      </div>
    </div>

    <!-- Formulario -->
    <div class="form-control mb-6">
      <label class="label">
        <span class="label-text font-medium flex items-center gap-2">
          <i-lucide [img]="DollarSign" class="w-4 h-4"></i-lucide>
          Monto a recargar
        </span>
        <span class="label-text-alt text-error">*Requerido</span>
      </label>
      <div class="join w-full">
        <span class="btn btn-ghost join-item no-animation">GTQ</span>
        <input
          [(ngModel)]="rechargeAmount"
          type="number"
          min="1"
          step="0.01"
          placeholder="0.00"
          class="input input-bordered join-item w-full focus:input-primary"
        />
      </div>
      <label class="label">
        <span class="label-text-alt opacity-70">Mínimo: Q1.00</span>
      </label>
    </div>

    <!-- Preview del nuevo balance -->
    @if (rechargeAmount() > 0) {
    <div class="alert alert-success mb-4">
      <i-lucide [img]="CheckCircle" class="w-5 h-5"></i-lucide>
      <div>
        <p class="text-sm">Nuevo balance después de la recarga:</p>
        <p class="font-bold">
          {{
            wallet()!.balance + rechargeAmount()
              | currency : "GTQ" : "symbol" : "1.2-2"
          }}
        </p>
      </div>
    </div>
    }

    <!-- Acciones -->
    <div class="modal-action">
      <button class="btn btn-ghost gap-2" (click)="closeModalRecharge()">
        <i-lucide [img]="X" class="w-4 h-4"></i-lucide>
        Cancelar
      </button>
      <button class="btn btn-success gap-2" (click)="rechargeWallet()">
        <i-lucide [img]="ArrowUpCircle" class="w-4 h-4"></i-lucide>
        Confirmar Recarga
      </button>
    </div>
  </div>
</dialog>

<!-- Modal de Pago de Estancia -->
<dialog #modalPayStay id="modal-pay-stay" class="modal">
  <div class="modal-box max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-error/10 p-3 rounded-lg">
          <i-lucide [img]="Home" class="w-6 h-6 text-error"></i-lucide>
        </div>
        <div>
          <h3 class="text-xl font-bold">Pago de Estancia</h3>
          <p class="text-sm opacity-70">
            Paga el uso de las instalaciones del cine
          </p>
        </div>
      </div>
      <button
        class="btn btn-ghost btn-sm btn-circle"
        (click)="closeModalPayStay()"
      >
        <i-lucide [img]="X" class="w-5 h-5"></i-lucide>
      </button>
    </div>

    <!-- Balance e info del cine -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="alert alert-info">
        <i-lucide [img]="WalletIcon" class="w-5 h-5"></i-lucide>
        <div>
          <p class="text-xs">Balance:</p>
          <p class="font-bold">
            {{ wallet()?.balance | currency : "GTQ" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>

      <div class="alert alert-warning">
        <i-lucide [img]="Home" class="w-5 h-5"></i-lucide>
        <div>
          <p class="text-xs">Costo por día:</p>
          <p class="font-bold">
            {{ cinema()?.dailyCost | currency : "GTQ" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>
    </div>

    <!-- Historial de pagos de estancia -->
    @if (payCinemaList().length > 0) {
    <div class="card bg-base-100 border border-base-300 mb-4">
      <div class="card-body p-4">
        <h4 class="font-bold text-sm mb-3 flex items-center gap-2">
          <i-lucide [img]="Clock" class="w-4 h-4 text-primary"></i-lucide>
          Historial de Pagos de Estancia
        </h4>
        <div class="max-h-48 overflow-y-auto space-y-2">
          @for (payment of payCinemaList(); track payment.id) {
          <div
            class="flex items-center justify-between text-xs p-2 bg-base-200 rounded"
          >
            <div class="flex-1">
              <div class="flex items-center gap-1 mb-1">
                <i-lucide
                  [img]="Calendar"
                  class="w-3 h-3 opacity-70"
                ></i-lucide>
                <span class="font-medium">
                  {{ payment.startDate | date : "dd/MM/yyyy" }} -
                  {{ payment.endDate | date : "dd/MM/yyyy" }}
                </span>
              </div>
              <div class="opacity-70">
                {{ payment.days }} día{{ payment.days !== 1 ? "s" : "" }}
              </div>
            </div>
            <div class="text-right">
              <span class="font-bold text-error">
                {{ payment.pricePaid | currency : "GTQ" : "symbol" : "1.2-2" }}
              </span>
            </div>
          </div>
          }
        </div>
      </div>
    </div>
    }

    <!-- Formulario -->
    <div class="space-y-4 mb-6">
      <!-- Fecha de inicio (solo lectura) -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium flex items-center gap-2">
            <i-lucide [img]="Calendar" class="w-4 h-4"></i-lucide>
            Fecha de inicio del período
          </span>
          <span class="badge badge-info badge-sm">Automático</span>
        </label>
        <input
          [value]="payStayStartDate()"
          type="date"
          disabled
          class="input input-bordered w-full bg-base-200"
        />
        <label class="label">
          <span class="label-text-alt opacity-70">
            @if (isFirstPayment()) { Esta es la fecha de creación de tu cine }
            @else { Esta es la fecha de tu último pago }
          </span>
        </label>
      </div>

      <!-- Fecha fin -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium flex items-center gap-2">
            <i-lucide [img]="Calendar" class="w-4 h-4"></i-lucide>
            Fecha de fin del período
          </span>
          <span class="label-text-alt text-error">*Requerido</span>
        </label>
        <input
          [(ngModel)]="payStayEndDate"
          (ngModelChange)="calculatePayStayAmount()"
          type="date"
          [min]="getMinEndDate()"
          class="input input-bordered w-full focus:input-primary"
        />
        <label class="label">
          <span class="label-text-alt opacity-70">
            Debe ser al menos un día después de la fecha de inicio
          </span>
        </label>
      </div>

      <!-- Info adicional -->
      <div class="alert">
        <i-lucide [img]="AlertCircle" class="w-5 h-5"></i-lucide>
        <div class="text-xs">
          <p><strong>Importante:</strong></p>
          <p>• La fecha de inicio se calcula automáticamente</p>
          <p>• No puedes elegir la misma fecha de inicio como fecha fin</p>
          <p>• El cálculo excluye el día de inicio (ya está pagado)</p>
          <p>• No puede haber traslape con otros pagos de estancia</p>
        </div>
      </div>
    </div>

    <!-- Cálculo del monto -->
    @if (payStayAmount() > 0) {
    <div class="card bg-base-200 mb-4">
      <div class="card-body">
        <h4 class="card-title text-lg">Resumen del Pago</h4>
        <div class="space-y-2">
          <div class="flex justify-between text-sm opacity-70">
            <span>Período:</span>
            <span>
              {{ payStayStartDate() | date : "dd/MM/yyyy" }} -
              {{ payStayEndDate() | date : "dd/MM/yyyy" }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="opacity-70">Costo por día:</span>
            <span class="font-semibold">{{
              cinema()?.dailyCost | currency : "GTQ" : "symbol" : "1.2-2"
            }}</span>
          </div>
          <div class="flex justify-between text-sm opacity-70">
            <span>Días a pagar:</span>
            <span>
              {{ payStayAmount() / (cinema()?.dailyCost || 1) }} día(s)
            </span>
          </div>
          <div class="divider my-1"></div>
          <div class="flex justify-between text-lg">
            <span class="font-bold">Total a pagar:</span>
            <span class="font-bold text-error">
              {{ payStayAmount() | currency : "GTQ" : "symbol" : "1.2-2" }}
            </span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="opacity-70">Balance restante:</span>
            <span
              class="font-semibold"
              [ngClass]="{
                'text-success': wallet()!.balance >= payStayAmount(),
                'text-error': wallet()!.balance < payStayAmount()
              }"
            >
              {{
                wallet()!.balance - payStayAmount()
                  | currency : "GTQ" : "symbol" : "1.2-2"
              }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Advertencias -->
    @if (wallet()!.balance < payStayAmount()) {
    <div class="alert alert-error mb-4">
      <i-lucide [img]="AlertCircle" class="w-5 h-5"></i-lucide>
      <span>No tienes saldo suficiente. Necesitas recargar tu cartera.</span>
    </div>
    } @if (hasOverlappingPayments()) {
    <div class="alert alert-error mb-4">
      <i-lucide [img]="AlertCircle" class="w-5 h-5"></i-lucide>
      <span>Ya existe un pago en el rango de fechas seleccionado.</span>
    </div>
    } }

    <!-- Acciones -->
    <div class="modal-action">
      <button class="btn btn-ghost gap-2" (click)="closeModalPayStay()">
        <i-lucide [img]="X" class="w-4 h-4"></i-lucide>
        Cancelar
      </button>
      <button
        class="btn btn-error gap-2"
        (click)="payStay()"
        [disabled]="
          !payStayStartDate() ||
          !payStayEndDate() ||
          payStayAmount() <= 0 ||
          wallet()!.balance < payStayAmount() ||
          hasOverlappingPayments()
        "
      >
        <i-lucide [img]="Home" class="w-4 h-4"></i-lucide>
        Confirmar Pago
      </button>
    </div>
  </div>
</dialog>

<!-- Modal de Pago de Bloqueo de Anuncios -->
<dialog #modalPayAdBlock id="modal-pay-adblock" class="modal">
  <div class="modal-box max-w-2xl">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-warning/10 p-3 rounded-lg">
          <i-lucide [img]="Ban" class="w-6 h-6 text-warning"></i-lucide>
        </div>
        <div>
          <h3 class="text-xl font-bold">Bloquear Anuncios</h3>
          <p class="text-sm opacity-70">
            Bloquea anuncios en todas las páginas de tu cine
          </p>
        </div>
      </div>
      <button
        class="btn btn-ghost btn-sm btn-circle"
        (click)="closeModalPayAdBlock()"
      >
        <i-lucide [img]="X" class="w-5 h-5"></i-lucide>
      </button>
    </div>

    <!-- Balance e info del costo -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div class="alert alert-info">
        <i-lucide [img]="WalletIcon" class="w-5 h-5"></i-lucide>
        <div>
          <p class="text-xs">Balance:</p>
          <p class="font-bold">
            {{ wallet()?.balance | currency : "GTQ" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>

      <div class="alert alert-warning">
        <i-lucide [img]="Ban" class="w-5 h-5"></i-lucide>
        <div>
          <p class="text-xs">Costo por día:</p>
          <p class="font-bold">
            {{ adBlockDailyCost() | currency : "GTQ" : "symbol" : "1.2-2" }}
          </p>
        </div>
      </div>
    </div>

    <!-- Último bloqueo activo -->
    @if (adBlocks().length > 0) {
    <div class="card bg-base-100 border border-base-300 mb-4">
      <div class="card-body p-4">
        <h4 class="font-bold text-sm mb-2 flex items-center gap-2">
          <i-lucide [img]="History" class="w-4 h-4 text-primary"></i-lucide>
          @if (activeAdBlock()) { Bloqueo Activo Actual } @else { Último Bloqueo
          Registrado }
        </h4>
        <div class="text-xs p-2 bg-base-200 rounded">
          <div class="flex items-center gap-1 mb-1">
            <i-lucide [img]="Calendar" class="w-3 h-3 opacity-70"></i-lucide>
            <span class="font-medium">
              @if (activeAdBlock()) {
              {{ activeAdBlock()!.startDate | date : "dd/MM/yyyy" }} -
              {{ activeAdBlock()!.endDate | date : "dd/MM/yyyy" }} } @else {
              {{ adBlocks()[0].startDate | date : "dd/MM/yyyy" }} -
              {{ adBlocks()[0].endDate | date : "dd/MM/yyyy" }} }
            </span>
          </div>
          <div class="opacity-70 flex items-center gap-2">
            <span
              >@if (activeAdBlock()) { {{ activeAdBlock()!.durationDays }} }
              @else { {{ adBlocks()[0].durationDays }} } día(s)</span
            >
            <span
              class="badge badge-sm"
              [ngClass]="{
                'badge-success':
                  (activeAdBlock()
                    ? activeAdBlock()!.adStatus
                    : adBlocks()[0].adStatus) === 'ACTIVE',
                'badge-warning':
                  (activeAdBlock()
                    ? activeAdBlock()!.adStatus
                    : adBlocks()[0].adStatus) === 'PENDING_PAYMENT',
                'badge-error':
                  (activeAdBlock()
                    ? activeAdBlock()!.adStatus
                    : adBlocks()[0].adStatus) === 'EXPIRED' ||
                  (activeAdBlock()
                    ? activeAdBlock()!.adStatus
                    : adBlocks()[0].adStatus) === 'REJECTED'
              }"
            >
              @if (activeAdBlock()) { {{ activeAdBlock()!.adStatus }} } @else {
              {{ adBlocks()[0].adStatus }} }
            </span>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- Formulario -->
    <div class="space-y-4 mb-6">
      <!-- Fecha de inicio (solo lectura) -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium flex items-center gap-2">
            <i-lucide [img]="Calendar" class="w-4 h-4"></i-lucide>
            Fecha de inicio del bloqueo
          </span>
          <span class="badge badge-info badge-sm">Automático</span>
        </label>
        <input
          [value]="adBlockStartDate()"
          type="date"
          disabled
          class="input input-bordered w-full bg-base-200"
        />
        <label class="label">
          <span class="label-text-alt opacity-70">
            @if (isFirstAdBlock()) { Primera vez - Comienza desde hoy } @else {
            Basado en el último bloqueo válido (activo o expirado) }
          </span>
        </label>
      </div>

      <!-- Fecha fin -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium flex items-center gap-2">
            <i-lucide [img]="Calendar" class="w-4 h-4"></i-lucide>
            Fecha de fin del bloqueo
          </span>
          <span class="label-text-alt text-error">*Requerido</span>
        </label>
        <input
          [(ngModel)]="adBlockEndDate"
          (ngModelChange)="calculateAdBlockAmount()"
          type="date"
          [min]="getAdBlockMinEndDate()"
          class="input input-bordered w-full focus:input-primary"
        />
        <label class="label">
          <span class="label-text-alt opacity-70">
            Debe ser al menos un día después de la fecha de inicio
          </span>
        </label>
      </div>

      <!-- Info adicional -->
      <div class="alert">
        <i-lucide [img]="AlertCircle" class="w-5 h-5"></i-lucide>
        <div class="text-xs">
          <p><strong>Importante:</strong></p>
          <p>• El bloqueo evita que se muestren anuncios en tu cine</p>
          <p>• La fecha de inicio se calcula automáticamente</p>
          <p>
            • Costo:
            {{ adBlockDailyCost() | currency : "GTQ" : "symbol" : "1.2-2" }}
            por día
          </p>
          <p>• No puede haber traslape con otros bloqueos activos</p>
        </div>
      </div>
    </div>

    <!-- Cálculo del monto -->
    @if (adBlockAmount() > 0) {
    <div class="card bg-base-200 mb-4">
      <div class="card-body">
        <h4 class="card-title text-lg">Resumen del Bloqueo</h4>
        <div class="space-y-2">
          <div class="flex justify-between text-sm opacity-70">
            <span>Período:</span>
            <span>
              {{ adBlockStartDate() | date : "dd/MM/yyyy" }} -
              {{ adBlockEndDate() | date : "dd/MM/yyyy" }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="opacity-70">Costo por día:</span>
            <span class="font-semibold">{{
              adBlockDailyCost() | currency : "GTQ" : "symbol" : "1.2-2"
            }}</span>
          </div>
          <div class="flex justify-between text-sm opacity-70">
            <span>Días a bloquear:</span>
            <span>{{ adBlockAmount() / adBlockDailyCost() }} día(s)</span>
          </div>
          <div class="divider my-1"></div>
          <div class="flex justify-between text-lg">
            <span class="font-bold">Total a pagar:</span>
            <span class="font-bold text-warning">
              {{ adBlockAmount() | currency : "GTQ" : "symbol" : "1.2-2" }}
            </span>
          </div>
          <div class="flex justify-between text-sm">
            <span class="opacity-70">Balance restante:</span>
            <span
              class="font-semibold"
              [ngClass]="{
                'text-success': wallet()!.balance >= adBlockAmount(),
                'text-error': wallet()!.balance < adBlockAmount()
              }"
            >
              {{
                wallet()!.balance - adBlockAmount()
                  | currency : "GTQ" : "symbol" : "1.2-2"
              }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Advertencias -->
    @if (wallet()!.balance < adBlockAmount()) {
    <div class="alert alert-error mb-4">
      <i-lucide [img]="AlertCircle" class="w-5 h-5"></i-lucide>
      <span>No tienes saldo suficiente. Necesitas recargar tu cartera.</span>
    </div>
    } @if (hasOverlappingAdBlocks()) {
    <div class="alert alert-error mb-4">
      <i-lucide [img]="AlertCircle" class="w-5 h-5"></i-lucide>
      <span>Ya existe un bloqueo en el rango de fechas seleccionado.</span>
    </div>
    } }

    <!-- Acciones -->
    <div class="modal-action">
      <button class="btn btn-ghost gap-2" (click)="closeModalPayAdBlock()">
        <i-lucide [img]="X" class="w-4 h-4"></i-lucide>
        Cancelar
      </button>
      <button
        class="btn btn-warning gap-2"
        (click)="payAdBlock()"
        [disabled]="
          !adBlockStartDate() ||
          !adBlockEndDate() ||
          adBlockAmount() <= 0 ||
          wallet()!.balance < adBlockAmount() ||
          hasOverlappingAdBlocks()
        "
      >
        <i-lucide [img]="Ban" class="w-4 h-4"></i-lucide>
        Confirmar Bloqueo
      </button>
    </div>
  </div>
</dialog>

<!-- Modal de Historial de Pagos de Estancia -->
<dialog #modalHistoryStay id="modal-history-stay" class="modal">
  <div class="modal-box max-w-4xl">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-error/10 p-3 rounded-lg">
          <i-lucide [img]="History" class="w-6 h-6 text-error"></i-lucide>
        </div>
        <div>
          <h3 class="text-xl font-bold">Historial de Pagos de Estancia</h3>
          <p class="text-sm opacity-70">
            {{ payCinemaList().length }} pago{{
              payCinemaList().length !== 1 ? "s" : ""
            }}
            registrado{{ payCinemaList().length !== 1 ? "s" : "" }}
          </p>
        </div>
      </div>
      <button
        class="btn btn-ghost btn-sm btn-circle"
        (click)="closeModalHistoryStay()"
      >
        <i-lucide [img]="X" class="w-5 h-5"></i-lucide>
      </button>
    </div>

    @if (payCinemaList().length === 0) {
    <div class="text-center py-12">
      <div
        class="bg-base-200 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <i-lucide [img]="Home" class="w-10 h-10 opacity-30"></i-lucide>
      </div>
      <p class="text-lg font-semibold mb-2">No hay pagos registrados</p>
      <p class="text-sm opacity-70">
        Aún no has realizado ningún pago de estancia
      </p>
    </div>
    } @else {
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead class="bg-base-200">
          <tr>
            <th class="font-bold">Período</th>
            <th class="font-bold">Días</th>
            <th class="font-bold">Monto Pagado</th>
            <th class="font-bold">Estado</th>
          </tr>
        </thead>
        <tbody>
          @for (payment of payCinemaList(); track payment.id) {
          <tr>
            <td>
              <div class="flex items-center gap-2">
                <i-lucide
                  [img]="Calendar"
                  class="w-4 h-4 opacity-70"
                ></i-lucide>
                <div>
                  <div class="font-medium">
                    {{ payment.startDate | date : "dd/MM/yyyy" }}
                  </div>
                  <div class="text-xs opacity-70">
                    hasta {{ payment.endDate | date : "dd/MM/yyyy" }}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge badge-outline"
                >{{ payment.days }} día{{ payment.days !== 1 ? "s" : "" }}</span
              >
            </td>
            <td>
              <span class="font-bold text-error">
                {{ payment.pricePaid | currency : "GTQ" : "symbol" : "1.2-2" }}
              </span>
            </td>
            <td>
              <span class="badge badge-success gap-1">
                <i-lucide [img]="CheckCircle" class="w-3 h-3"></i-lucide>
                Pagado
              </span>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }

    <div class="modal-action">
      <button class="btn btn-ghost gap-2" (click)="closeModalHistoryStay()">
        <i-lucide [img]="X" class="w-4 h-4"></i-lucide>
        Cerrar
      </button>
    </div>
  </div>
</dialog>

<!-- Modal de Historial de Bloqueos de Anuncios -->
<dialog #modalHistoryAdBlock id="modal-history-adblock" class="modal">
  <div class="modal-box max-w-4xl">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-warning/10 p-3 rounded-lg">
          <i-lucide [img]="History" class="w-6 h-6 text-warning"></i-lucide>
        </div>
        <div>
          <h3 class="text-xl font-bold">Historial de Bloqueos de Anuncios</h3>
          <p class="text-sm opacity-70">
            {{ adBlocks().length }} bloqueo{{
              adBlocks().length !== 1 ? "s" : ""
            }}
            registrado{{ adBlocks().length !== 1 ? "s" : "" }}
          </p>
        </div>
      </div>
      <button
        class="btn btn-ghost btn-sm btn-circle"
        (click)="closeModalHistoryAdBlock()"
      >
        <i-lucide [img]="X" class="w-5 h-5"></i-lucide>
      </button>
    </div>

    @if (adBlocks().length === 0) {
    <div class="text-center py-12">
      <div
        class="bg-base-200 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4"
      >
        <i-lucide [img]="Ban" class="w-10 h-10 opacity-30"></i-lucide>
      </div>
      <p class="text-lg font-semibold mb-2">No hay bloqueos registrados</p>
      <p class="text-sm opacity-70">Aún no has bloqueado anuncios en tu cine</p>
    </div>
    } @else {
    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead class="bg-base-200">
          <tr>
            <th class="font-bold">Período</th>
            <th class="font-bold">Duración</th>
            <th class="font-bold">Monto Pagado</th>
            <th class="font-bold">Estado</th>
          </tr>
        </thead>
        <tbody>
          @for (block of adBlocks(); track block.id) {
          <tr>
            <td>
              <div class="flex items-center gap-2">
                <i-lucide
                  [img]="Calendar"
                  class="w-4 h-4 opacity-70"
                ></i-lucide>
                <div>
                  <div class="font-medium">
                    {{ block.startDate | date : "dd/MM/yyyy" }}
                  </div>
                  <div class="text-xs opacity-70">
                    hasta {{ block.endDate | date : "dd/MM/yyyy" }}
                  </div>
                </div>
              </div>
            </td>
            <td>
              <span class="badge badge-outline"
                >{{ block.durationDays }} día{{
                  block.durationDays !== 1 ? "s" : ""
                }}</span
              >
            </td>
            <td>
              <span class="font-bold text-warning">
                {{ block.pricePaid | currency : "GTQ" : "symbol" : "1.2-2" }}
              </span>
            </td>
            <td>
              <span
                class="badge gap-1"
                [ngClass]="{
                  'badge-success': block.adStatus === 'ACTIVE',
                  'badge-warning': block.adStatus === 'PENDING_PAYMENT',
                  'badge-error':
                    block.adStatus === 'EXPIRED' ||
                    block.adStatus === 'REJECTED'
                }"
              >
                @if (block.adStatus === 'ACTIVE') {
                <i-lucide [img]="CheckCircle" class="w-3 h-3"></i-lucide>
                Activo } @else if (block.adStatus === 'PENDING_PAYMENT') {
                <i-lucide [img]="Clock" class="w-3 h-3"></i-lucide>
                Pendiente } @else if (block.adStatus === 'EXPIRED') {
                <i-lucide [img]="XCircle" class="w-3 h-3"></i-lucide>
                Expirado } @else {
                <i-lucide [img]="XCircle" class="w-3 h-3"></i-lucide>
                Rechazado }
              </span>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }

    <div class="modal-action">
      <button class="btn btn-ghost gap-2" (click)="closeModalHistoryAdBlock()">
        <i-lucide [img]="X" class="w-4 h-4"></i-lucide>
        Cerrar
      </button>
    </div>
  </div>
</dialog>
