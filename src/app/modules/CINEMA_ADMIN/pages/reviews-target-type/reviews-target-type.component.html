<div class="container mx-auto p-6 max-w-7xl">
  <!-- Header con información del target -->
  <div class="mb-8">
    <div class="flex items-center gap-3 mb-4">
      <button class="btn btn-ghost btn-sm gap-2" onclick="history.back()">
        <i-lucide [img]="ArrowLeft" class="w-4 h-4"></i-lucide>
        Volver
      </button>
    </div>

    @if (target()) {
    <!-- Card del target (Room o Snack) -->
    <div class="card bg-base-100 shadow-xl border border-base-300">
      <div class="card-body">
        <div class="flex flex-col md:flex-row gap-6">
          <!-- Imagen -->
          <div class="w-full md:w-48 h-48 flex-shrink-0">
            <img
              [src]="target()!.imageUrl | image"
              [alt]="target()!.name"
              class="w-full h-full object-cover rounded-lg"
            />
          </div>

          <!-- Información -->
          <div class="flex-1">
            <div class="flex items-start justify-between mb-4">
              <div>
                <div class="flex items-center gap-2 mb-2">
                  <span class="badge badge-primary badge-sm">
                    {{ targetType() === "room" ? "Sala" : "Snack" }}
                  </span>
                  @if (targetType() === 'room' &&
                  $any(target()).commentsEnabled) {
                  <span class="badge badge-success badge-sm gap-1">
                    <i-lucide [img]="MessageSquare" class="w-3 h-3"></i-lucide>
                    Opiniones Habilitadas
                  </span>
                  }
                </div>
                <h1 class="text-3xl font-bold flex items-center gap-3">
                  <i-lucide
                    [img]="targetType() === 'room' ? DoorOpen : Popcorn"
                    class="w-8 h-8 text-primary"
                  ></i-lucide>
                  {{ target()!.name }}
                </h1>
              </div>

              <!-- Rating promedio -->
              <div class="text-right">
                <div class="flex items-center gap-2 justify-end mb-1">
                  <i-lucide
                    [img]="Star"
                    class="w-6 h-6 text-warning fill-warning"
                  ></i-lucide>
                  <span class="text-3xl font-bold">{{
                    getAverageRating() | number : "1.1-1"
                  }}</span>
                </div>
                <p class="text-sm opacity-70">
                  {{ reviews().length }} opinión{{
                    reviews().length !== 1 ? "es" : ""
                  }}
                </p>
              </div>
            </div>

            <p class="text-sm opacity-80 mb-4">
              {{ target()!.description }}
            </p>

            <!-- Información específica del tipo -->
            <div class="flex flex-wrap gap-4 text-sm">
              @if (targetType() === 'room') {
              <div class="flex items-center gap-2">
                <i-lucide [img]="Users" class="w-4 h-4 opacity-70"></i-lucide>
                <span
                  >Capacidad:
                  <strong>{{ $any(target()).capacity }}</strong></span
                >
              </div>
              <div class="flex items-center gap-2">
                <i-lucide [img]="Grid3x3" class="w-4 h-4 opacity-70"></i-lucide>
                <span
                  >{{ $any(target()).rows }}x{{ $any(target()).columns }}</span
                >
              </div>
              } @else {
              <div class="flex items-center gap-2">
                <i-lucide
                  [img]="DollarSign"
                  class="w-4 h-4 opacity-70"
                ></i-lucide>
                <span
                  >Precio:
                  <strong>{{
                    $any(target()).price | currency : "GTQ"
                  }}</strong></span
                >
              </div>
              <div class="flex items-center gap-2">
                <i-lucide [img]="Package" class="w-4 h-4 opacity-70"></i-lucide>
                <span
                  >Costo:
                  <strong>{{
                    $any(target()).cost | currency : "GTQ"
                  }}</strong></span
                >
              </div>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
    }
  </div>

  <!-- Sección de opiniones -->
  <div class="mb-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold flex items-center gap-2">
        <i-lucide [img]="MessageSquare" class="w-6 h-6 text-primary"></i-lucide>
        Opiniones de usuarios
      </h2>

      <!-- Filtros de puntuación -->
      <div class="flex gap-2">
        <button class="btn btn-sm btn-ghost gap-1">
          <i-lucide [img]="Filter" class="w-4 h-4"></i-lucide>
          Todas
        </button>
      </div>
    </div>

    <!-- Lista de opiniones -->
    <div class="space-y-4">
      @for (review of reviews(); track review.id) {
      <div
        class="card bg-base-100 shadow-md border border-base-300 hover:border-primary transition-all duration-300"
      >
        <div class="card-body">
          <div class="flex gap-4">
            <!-- Avatar genérico -->
            <div class="flex-shrink-0">
              <div class="avatar placeholder">
                <div
                  class="bg-primary text-primary-content w-12 h-12 rounded-full"
                >
                  <i-lucide [img]="User" class="w-6 h-6"></i-lucide>
                </div>
              </div>
            </div>

            <!-- Contenido de la opinión -->
            <div class="flex-1">
              <!-- Header con nombre y puntuación -->
              <div class="flex items-start justify-between mb-2">
                <div>
                  <h3 class="font-semibold text-lg">{{ review.userName }}</h3>
                  <p class="text-xs opacity-60 flex items-center gap-1">
                    <i-lucide [img]="Calendar" class="w-3 h-3"></i-lucide>
                    {{ review.createdAt | date : "dd/MM/yyyy HH:mm" }}
                  </p>
                </div>

                <!-- Puntuación -->
                <div class="flex items-center gap-2">
                  <div class="flex gap-0.5">
                    @for (star of [1,2,3,4,5]; track star) {
                    <i-lucide
                      [img]="Star"
                      class="w-5 h-5"
                      [ngClass]="{
                        'text-warning fill-warning': star <= review.rating,
                        'text-base-300': star > review.rating
                      }"
                    ></i-lucide>
                    }
                  </div>
                  <span class="font-bold text-lg">{{ review.rating }}.0</span>
                </div>
              </div>

              <!-- Título de la opinión -->
              <h4 class="font-semibold text-base mb-2 flex items-center gap-2">
                <i-lucide
                  [img]="MessageCircle"
                  class="w-4 h-4 text-primary"
                ></i-lucide>
                {{ review.title }}
              </h4>

              <!-- Comentario -->
              <p class="text-sm opacity-80 mb-3">
                {{ review.comment }}
              </p>

              <!-- Footer con acciones -->
              <div
                class="flex items-center justify-between pt-2 border-t border-base-300"
              >
                <div class="flex items-center gap-2 text-xs opacity-60">
                  <i-lucide [img]="Info" class="w-3 h-3"></i-lucide>
                  <span>ID: {{ review.id.substring(0, 8) }}...</span>
                </div>

                <!-- Botón eliminar -->
                <button
                  class="btn btn-ghost btn-sm text-error gap-1 hover:bg-error hover:text-error-content"
                  (click)="confirmDelete(review)"
                >
                  <i-lucide [img]="Trash2" class="w-4 h-4"></i-lucide>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      } @empty {
      <!-- Estado vacío -->
      <div class="card bg-base-100 shadow-md border border-base-300">
        <div class="card-body">
          <div class="flex flex-col items-center justify-center py-12">
            <div class="bg-base-200 p-6 rounded-full mb-4">
              <i-lucide
                [img]="MessageSquare"
                class="w-16 h-16 opacity-30"
              ></i-lucide>
            </div>
            <h3 class="text-xl font-semibold mb-2">No hay opiniones aún</h3>
            <p class="text-sm opacity-70 text-center max-w-md">
              Todavía no hay opiniones para este
              {{ targetType() === "room" ? "sala" : "producto" }}. Las opiniones
              de los usuarios aparecerán aquí.
            </p>
          </div>
        </div>
      </div>
      }
    </div>
  </div>

  <!-- Estadísticas de puntuaciones -->
  @if (reviews().length > 0) {
  <div class="card bg-base-100 shadow-md border border-base-300 mt-6">
    <div class="card-body">
      <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
        <i-lucide [img]="BarChart3" class="w-5 h-5 text-primary"></i-lucide>
        Distribución de puntuaciones
      </h3>

      <div class="space-y-2">
        @for (rating of [5,4,3,2,1]; track rating) {
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium w-8">{{ rating }} ★</span>
          <progress
            class="progress progress-warning w-full"
            [value]="getRatingCount(rating)"
            [max]="reviews().length"
          ></progress>
          <span class="text-sm opacity-70 w-12 text-right">{{
            getRatingCount(rating)
          }}</span>
        </div>
        }
      </div>
    </div>
  </div>
  }
</div>

<dialog #deleteModal id="my_modal_1" class="modal">
  <div >
    <div class="modal-box">
      <h2 class="font-semibold text-lg">Eliminar opinión</h2>
      <p class="py-4">¿Estás seguro de que deseas eliminar esta opinión?</p>
      <div class="modal-action">
        <button type="button" class="btn" (click)="closeDeleteModal()">
          Cancelar
        </button>
        <button class="btn btn-error" (click)="deleteReviewModal()">Eliminar</button>
      </div>
    </div>
  </div>
</dialog>
